<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ladok</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
  <header class="topbar">
    <h1>Ladok</h1>
    <nav>
      <button id="btn-students">Studenter</button>
      <button id="btn-courses">Kurser</button>
      <button id="btn-profile">Min profil</button>
    </nav>
</header>


<main class="container">
<section id="login" class="card">
<h2>Logga in</h2>
<form id="loginForm">
  <label>Username <input name="username" required></label>
  <label>Password <input name="password" type="password" required></label>
  <button type="submit">Logga in</button>
</form>
  <p id="loginMsg" class="msg"></p>
</section>


<section id="students" class="card hidden">
<h2>Studenter</h2>
  <div class="toolbar">
    <input id="search" placeholder="Sök namn eller id">
    <button id="refresh">Uppdatera</button>
  </div>
<ul id="studentList" class="list"></ul>
</section>


<section id="studentDetail" class="card hidden">
<button id="backToList" class="link">← Tillbaka</button>
<h2 id="sd-name">Student</h2>
<p><strong>ID:</strong> <span id="sd-id"></span></p>
<p><strong>Program:</strong> <span id="sd-program"></span></p>


<h3>Registrera kurs</h3>
<form id="regForm">
<label>Kurskod <input name="course_code" required></label>
<button type="submit">Registrera</button>
</form>
<p id="regMsg" class="msg"></p>


<h3>Registrerade kurser</h3>
<ul id="enrolments" class="list"></ul>
</section>


<section id="courses" class="card hidden">
<h2>Kurser</h2>
<ul id="courseList" class="list"></ul>
</section>


<section id="profile" class="card hidden">
<h2>Min profil</h2>
<div id="profileContent">Du är inte inloggad.</div>
</section>
</main>


<footer class="foot">Ladok</footer>


<script>
  const API_BASE = '../api';

  let currentUser = null;
  let currentStudent = null;
  let currentEnrolments = []; // lokala "registrerade kurser" per student

  // ------------------ HJÄLPFUNKTIONER ------------------
  async function apiGet(path, params = {}) {
    const url = new URL(path, window.location.origin);
    Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
    const res = await fetch(url);
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  async function apiPost(path, data) {
    const res = await fetch(path, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  function showSection(id) {
    document.querySelectorAll('main section').forEach(sec => {
      sec.classList.add('hidden');
    });
    const el = document.getElementById(id);
    if (el) el.classList.remove('hidden');
  }

  // ------------------ LOGIN (via teachers/login.php + teachers.json) ------------------
  async function handleLogin(e) {
    e.preventDefault();
    const form = e.target;
    const username = form.username.value.trim();
    const password = form.password.value.trim();
    const msg = document.getElementById('loginMsg');
    msg.textContent = '';

    if (!username || !password) {
      msg.textContent = 'Fyll i både användarnamn och lösenord.';
      return;
    }

    try {
      // Anropa nya login.php som kollar teachers.json
      const result = await apiPost(`${API_BASE}/teachers/login.php`, {
        username,
        password
      });

      if (!result.authenticated) {
        msg.textContent = result.message || 'Ogiltigt användarnamn eller lösenord.';
        currentUser = null;
        updateProfileView();
        return;
      }

      // Spara inloggad lärare
      currentUser = {
        username: result.username,
        first_name: result.first_name,
        last_name: result.last_name,
        role: 'lärare'
      };

      msg.textContent = `Inloggad som ${result.first_name} ${result.last_name}.`;
      updateProfileView();

      // hoppa till student-vyn
      showSection('students');
      // ladda lite default-data
      loadStudentsForDefaultCourse();
    } catch (err) {
      console.error(err);
      msg.textContent = 'Fel vid inloggning.';
      currentUser = null;
      updateProfileView();
    }
  }

  function updateProfileView() {
    const profileDiv = document.getElementById('profileContent');
    if (!currentUser) {
      profileDiv.textContent = 'Du är inte inloggad.';
      return;
    }
    profileDiv.innerHTML = `
      <p><strong>Användarnamn:</strong> ${currentUser.username}</p>
      ${currentUser.first_name ? `<p><strong>Namn:</strong> ${currentUser.first_name} ${currentUser.last_name}</p>` : ''}
      <p><strong>Roll:</strong> ${currentUser.role}</p>
    `;
  }

  // ------------------ STUDENTER ------------------
  async function loadStudents(courseCode, assignment) {
    const list = document.getElementById('studentList');
    list.innerHTML = '<li class="list-item muted">Laddar...</li>';

    try {
      const data = await apiGet(`${API_BASE}/canvas/get_students.php`, {
        course_code: courseCode,
        assignment: assignment
      });

      const students = data.students || [];
      if (!students.length) {
        list.innerHTML = '<li class="list-item muted">Inga studenter hittades.</li>';
        return;
      }

      list.innerHTML = '';
      students.forEach(s => {
        const li = document.createElement('li');
        li.className = 'list-item';
        li.textContent = `${s.name} (${s.personnummer})`;
        li.addEventListener('click', () => {
          openStudentDetail(s, courseCode);
        });
        list.appendChild(li);
      });
    } catch (err) {
      console.error(err);
      list.innerHTML = '<li class="list-item muted">Fel vid hämtning av studenter.</li>';
    }
  }

  // litet "default"-fall så man ser något direkt
  function loadStudentsForDefaultCourse() {
    // Hitta något kurskod/assignment att använda.
    // Här hårdkodar vi ett exempel (ni kan ändra till verkliga värden i er JSON).
    const defaultCourse = 'DV001';
    const defaultAssignment = 'Lab1';
    loadStudents(defaultCourse, defaultAssignment);
  }

  function openStudentDetail(student, courseCode) {
    currentStudent = { ...student, course_code: courseCode };
    currentEnrolments = []; // nollställ lokala registreringar

    document.getElementById('sd-name').textContent = student.name;
    document.getElementById('sd-id').textContent =
    student.personnummer || student.id || '';
    document.getElementById('sd-program').textContent =
    student.program || student.programme || '-';

    document.getElementById('regMsg').textContent = '';
    document.getElementById('enrolments').innerHTML = '';

    showSection('studentDetail');
  }

  function renderEnrolments() {
    const ul = document.getElementById('enrolments');
    if (!currentEnrolments.length) {
      ul.innerHTML = '<li class="list-item muted">Inga registrerade kurser än.</li>';
      return;
    }
    ul.innerHTML = '';
    currentEnrolments.forEach(e => {
      const li = document.createElement('li');
      li.className = 'list-item';
      li.textContent = `${e.course_code} (${e.modul_code}) – betyg ${e.grade} ${e.date}`;
      ul.appendChild(li);
    });
  }

  // ------------------ REGISTRERA KURS/RESULTAT ------------------
  async function handleRegisterCourse(e) {
    e.preventDefault();
    if (!currentStudent) return;

    const form = e.target;
    const courseCode = form.course_code.value.trim();
    const msg = document.getElementById('regMsg');
    msg.textContent = '';

    if (!courseCode) {
      msg.textContent = 'Ange kurskod.';
      return;
    }

    // för demo: vi fejkbestämmer modul, betyg, datum här
    const payload = {
      personnummer: currentStudent.personnummer,
      course_code: courseCode,
      modul_code: 'MOD1',
      date: new Date().toISOString().slice(0, 10),
      grade: 'G'
    };

    try {
      const res = await apiPost(`${API_BASE}/ladok/reg_Resultat.php`, payload);
      if (res.status === 'registrerad') {
        msg.textContent = 'Kurs/resultat registrerat i mock-Ladok.';
        currentEnrolments.push(payload);
        renderEnrolments();
        form.reset();
      } else {
        msg.textContent = 'Något gick fel vid registreringen.';
      }
    } catch (err) {
      console.error(err);
      msg.textContent = 'Fel vid anrop till Ladok-API.';
    }
  }

  // ------------------ KURSER/ MODULER ------------------
  async function loadCoursesView() {
    const list = document.getElementById('courseList');
    list.innerHTML = '';

    const courseCode = prompt('Ange kurskod för att hämta moduler (EPOK):');
    if (!courseCode) {
      list.innerHTML = '<li class="list-item muted">Ingen kurskod angiven.</li>';
      return;
    }

    try {
      const data = await apiGet(`${API_BASE}/epok/get_Modul.php`, {
        course_code: courseCode
      });

      const modules = data.modules || [];
      if (!modules.length) {
        list.innerHTML = '<li class="list-item muted">Inga moduler hittades.</li>';
        return;
      }

      modules.forEach(m => {
        const li = document.createElement('li');
        li.className = 'list-item';
        li.textContent = `${m.code} – ${m.name}`;
        list.appendChild(li);
      });
    } catch (err) {
      console.error(err);
      list.innerHTML = '<li class="list-item muted">Fel vid hämtning av moduler.</li>';
    }
  }

  // ------------------ INIT & NAVIGATION ------------------
  document.addEventListener('DOMContentLoaded', () => {
    // loginform
    document
      .getElementById('loginForm')
      .addEventListener('submit', handleLogin);

    // registrera kurs/resultat
    document
      .getElementById('regForm')
      .addEventListener('submit', handleRegisterCourse);

    // tillbaka-knapp
    document.getElementById('backToList').addEventListener('click', () => {
      showSection('students');
    });

    // topbar-knappar
    document.getElementById('btn-students').addEventListener('click', () => {
      showSection('students');
      if (currentUser) {
        loadStudentsForDefaultCourse();
        const defaultCourse = 'D0005N';
        const defaultAssignment = '0008';
      }
    });

    document.getElementById('btn-courses').addEventListener('click', () => {
      showSection('courses');
      loadCoursesView();
    });

    document.getElementById('btn-profile').addEventListener('click', () => {
      showSection('profile');
      updateProfileView();
    });

    // Sök & uppdatera-knappar i studentlistan
    document.getElementById('refresh').addEventListener('click', () => {
      const search = document.getElementById('search').value.trim();
      // tolka "search" som t.ex. "DV001,Lab1"
      if (!search.includes(',')) {
        alert('Ange "kurskod,uppgift" i sökfältet, t.ex. "DV001,Lab1".');
        return;
      }
      const [course, assignment] = search.split(',').map(s => s.trim());
      if (!course || !assignment) {
        alert('Ange både kurskod och uppgiftsnamn t.ex. "DV001,Lab1".');
        return;
      }
      loadStudents(course, assignment);
    });
  });
</script>
</body>
</html>